# Dockerfile for hardware assessment - Chainguard multi-stage build
# Minimal container for detecting system resources and recommending Ollama models
# Stage 1: Builder - install dependencies
# Stage 2: Runtime - Chainguard distroless Python (no shell, no package manager)
#
# Security: Chainguard images have zero known CVEs vs 19+ in Debian-based distroless

# ============================================================
# STAGE 1: Builder
# ============================================================
FROM cgr.dev/chainguard/python:latest-dev AS builder

WORKDIR /app

# Install hardware detection dependencies in user directory
RUN pip install --user --no-cache-dir --no-warn-script-location \
    psutil==6.1.1 \
    py-cpuinfo==9.0.0

# Copy the assessment script
COPY scripts/assess-system.py /app/assess-system.py

# Verify imports work
RUN python -c "import psutil; import cpuinfo; print('âœ“ Hardware detection modules verified')"

# ============================================================
# STAGE 2: Chainguard Distroless Runtime
# ============================================================
FROM cgr.dev/chainguard/python:latest

# Copy Python packages from builder
COPY --from=builder /home/nonroot/.local /home/nonroot/.local

# Copy assessment script
COPY --from=builder /app/assess-system.py /app/assess-system.py

# Set working directory
WORKDIR /app

# Set Python path to include installed packages
# Chainguard uses Python 3.14
ENV PATH=/home/nonroot/.local/bin:/usr/bin:$PATH
ENV PYTHONPATH=/home/nonroot/.local/lib/python3.14/site-packages
ENV PYTHONUNBUFFERED=1

# Chainguard runs as nonroot user (uid 65532) by default
# No USER directive needed - it's built into the image

# Entry point - run the hardware assessment
CMD ["python", "/app/assess-system.py"]
